<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <button id="startstop">Start/Stop</button>
  <pre id="myPre"></pre>
  <canvas id="myCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/gh/idevelop/ascii-camera@f2e0cb364809c868013e0464ec71c626ac49086a/script/ascii.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/SignalR/sample-StreamR@6199ea8e2c811266c2e6d3c32c18f7745a7792a1/wwwroot/lib/camera.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@0.19.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.2.2/dist/jszip.min.js"></script>

  <script>
    const useCompression = true
    const apiBaseUrl = 'https://serverless-streamr.azurewebsites.net'
    // const apiBaseUrl = 'http://localhost:7071'
    const sendFrameFunctionAuthCode = 'qz/zWSw4d/TXZCRvPRtfRVPgz8cZd/mPGXXaI8v68QEitbrbWPCs1g=='

    const button = document.getElementById('startstop')
    const asciiCanvas = document.getElementById("myPre")
    let isStreaming = false

    const zipOptions = {
      type: 'binarystring',
      compression: 'DEFLATE',
      compressionOptions: {
        level: 9
      }
    }

    button.onclick = function () {
      if (isStreaming) {
        camera.stop()
        isStreaming = false
        asciiCanvas.innerHTML = ''
        return
      }

      camera.init({
        width: 60,
        height: 45,
        fps: 4,
        mirror: true,
        targetCanvas: document.getElementById("myCanvas"),

        onFrame: function (canvas) {
          ascii.fromCanvas(canvas, {
            contrast: 170,
            callback: function (asciiString) {
              asciiCanvas.innerText = asciiString

              // sender
              const sendUrl = `${apiBaseUrl}/api/sendframe?code=${sendFrameFunctionAuthCode}`
              if (useCompression) {
                const zip = new JSZip()
                zip.file('1', asciiString)
                zip.generateAsync(zipOptions).then(function (payload) {
                  axios.post(sendUrl, payload)
                })
              } else {
                axios.post(sendUrl, asciiString)
              }
            }
          })
        },

        onSuccess: function () {
          isStreaming = true
        },

        onError: function (error) {
          console.log(error)
        }
      })

    }
  </script>
</body>

</html>